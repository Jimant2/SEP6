@page "/searchresults"
@using Newtonsoft.Json;
@using SEP6.Data;
@using SEP6.Models;
@using SEP6.Pages.Components
@inject IMovieService movieService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Inputs


<h3>Search results</h3>


<div class="container">
    <table class="table">
        <tbody>

            @foreach (var movie in moviesList)
            {
                <tr>
                    <td>
                        <div>
                            <strong>Title: </strong>@movie.title

                        </div>
                        <div>
                            <strong>Year: </strong>@movie.year

                        </div>
                        <div>
                            <strong>Id: </strong>@movie.Id
                        </div>
                        <div>
                            <SfRating ShowTooltip="true" ItemsCount="10" Value="@movie.rating?.rating"> </SfRating>
                        </div>
                        <div>
                            <strong>Votes: </strong>@movie.rating?.votes
                        </div>
                        @if (movie.directors != null)
                        {
                        @foreach (var director in movie.directors)
                        {
                          
                            <div>
                                <strong>Directors: </strong>
                                @if(director.Name != null)
                                {
                                    @director.Name;
                                }
                            </div>
                        }
                        }
                        <div>
                            <div>
                                <strong>Stars: </strong>
                                @if (movie.directors != null)
                                {
                                    @foreach (var stars in movie.stars)
                                    {

                                        @stars.Name
                                        if (!stars.Equals(movie.stars.Last()))
                                        {
                                            @(
                                                                        ", "
                                                                        )
                                            ;
                                        }
                                    }
                                }
                            </div>
                        </div>
                        
                    </td>
                </tr>
            }

        </tbody>
    </table>
</div>
@code {

    [Parameter]
    public string searchedMovie { get; set; }
    public List<Movies> movies { get; set; }
    [Parameter]
    public List<Movies> moviesList { get; set; }
    [Parameter]
    public List<Movies> directorsList { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        Console.WriteLine("going through OnParamSet");
        var uri = new Uri(NavigationManager.Uri);
        var moviesJson = System.Web.HttpUtility.ParseQueryString(uri.Query).Get("movies");
        moviesList = JsonConvert.DeserializeObject<List<Movies>>(moviesJson);
        await base.OnParametersSetAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            NavigationManager.LocationChanged += HandleLocationChanged;
            HandleLocationChanged(null, new LocationChangedEventArgs(NavigationManager.Uri, true));
        }
    }

    //private void HandleLocationChanged(object sender, LocationChangedEventArgs args)
    //{
    //    var uri = new Uri(NavigationManager.Uri);
    //    var moviesJson = System.Web.HttpUtility.ParseQueryString(uri.Query).Get("movies");
    //    moviesList = JsonConvert.DeserializeObject<List<Movies>>(moviesJson);
    //    StateHasChanged();
    //}

    private void HandleLocationChanged(object sender, LocationChangedEventArgs args)
    {
        var uri = new Uri(NavigationManager.Uri);
        var moviesJson = System.Web.HttpUtility.ParseQueryString(uri.Query).Get("movies");

        if (!string.IsNullOrEmpty(moviesJson))
        {
            moviesList = JsonConvert.DeserializeObject<List<Movies>>(moviesJson);
        }
        else
        {
            moviesList = new List<Movies>();
        }

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        NavigationManager.LocationChanged -= HandleLocationChanged;
    }
    
}
